@page "/viagens/{idViagem:int}/{idDespesa:int}"
@inject IDespesasService<DespesaAlimentacaoDTO> DespesaAlimentacaoService
@inject IDespesasService<DespesaPassagemDTO> DespesaPassagemService
@inject IDespesasService<DespesaDeslocamentoDTO> DespesaDeslocamentoService
@inject NavigationManager NavigationManager

@if (TipoDespesa == string.Empty)
{
    <span>@Mensagem</span>
}
else
{    
    if(DespesasComponentes.TryGetValue(TipoDespesa, out var DespesaComponent))
    {
        @DespesaComponent
    }
}





@code {
    [Parameter]
    public int IdViagem { get; set; }

    [Parameter]
    public int IdDespesa { get; set; }

    [Parameter]
    public string TipoDespesa { get; set; } = string.Empty;

    private Dictionary<string, RenderFragment> DespesasComponentes = new();

    private string Mensagem { get; set; } = "Carregando despesa ...";

    protected override void OnInitialized()
    {        
        string tipoDespesa = NavigationManager.Uri.Split('?').LastOrDefault()?.Split('=')?.LastOrDefault() ?? string.Empty;
        TipoDespesa = HttpUtility.UrlDecode(tipoDespesa); //Essa linha formata a string. Por exemplo na Url o valor fica como Alimenta%C3%A7%C3%A3o mas essa linha deixa com o valor correto, Alimentação

        PopularDictionaries();
    }

    /*
    private async Task GetDespesaAlimentacao()
    {
        await DespesaAlimentacaoService.GetDespesa(IdDespesa);
        Despesa = DespesaAlimentacaoService.Despesa;
        //ApresentarNoConsole(Despesa);
        Mensagem = DespesaAlimentacaoService.Mensagem;
    }

    private async Task GetDespesaDeslocamento()
    {
        await DespesaDeslocamentoService.GetDespesa(IdDespesa);
        Despesa = DespesaDeslocamentoService.Despesa;
        //ApresentarNoConsole(Despesa);
        Mensagem = DespesaDeslocamentoService.Mensagem;
    }

    private async Task GetDespesaPassagem()
    {
        await DespesaPassagemService.GetDespesa(IdDespesa);
        Despesa = DespesaPassagemService.Despesa;
        //ApresentarNoConsole(Despesa);
        Mensagem = DespesaPassagemService.Mensagem;
    }
    */


    private void PopularDictionaries()
    {
        DespesasComponentes.Add("Hospedagem", builder => { 
            builder.OpenComponent(0, typeof(DespesaHospedagemForm));
            builder.AddAttribute(1, "IdDespesa", IdDespesa);
            builder.CloseComponent(); });

        
        //DespesasComponentes.Add("Deslocamento", builder => { builder.OpenComponent<DespesaDeslocamentoForm>(0); builder.CloseComponent(); });
        //DespesasComponentes.Add("Passagem", builder => { builder.OpenComponent<DespesaPassagemForm>(0); builder.CloseComponent(); });
        //DespesasComponentes.Add("Alimentacao", builder => { builder.OpenComponent<DespesaAlimentacaoForm>(0); builder.CloseComponent(); });
    }
}
